<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>AR.js • HIRO (Marker-Camera + VideoTexture)</title>

  <!-- Stable pair -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    /* Fill the screen with the WebGL canvas */
    canvas.a-canvas { position:fixed !important; inset:0 !important; width:100% !important; height:100% !important; }
    /* Simple HUD */
    #hud { position:fixed; top:8px; left:8px; z-index:10; background:rgba(0,0,0,.65); color:#0f0;
           font:12px/1.4 monospace; padding:6px 8px; border-radius:6px; display:none; white-space:pre-wrap; max-width:90vw; }
    #hud.show { display:block; }
    #hud.error { display:block; background:rgba(160,0,0,.85); color:#fff; }
    /* Start overlay */
    #overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; color:#fff; z-index:11;
               text-align:center; padding:24px; font:16px/1.5 system-ui,sans-serif; }
    #overlay button { margin-top:12px; padding:12px 16px; border:0; border-radius:10px; font-weight:700; background:#1e90ff; color:#fff; }
  </style>
</head>
<body>
  <div id="overlay">
    <div>
      <div>This needs your camera to show AR on the <b>HIRO</b> marker.</div>
      <button id="startBtn" type="button">Start AR</button>
      <div style="margin-top:10px; font-size:12px; opacity:.8">
        If you blocked the camera: Chrome → lock icon → Site settings → Camera → Allow.
      </div>
    </div>
  </div>
  <div id="hud">status: booting…</div>
  <div id="app"></div>

  <script>
    const hud = document.getElementById('hud');
    const overlay = document.getElementById('overlay');
    const app = document.getElementById('app');
    const log = (t, cls='show') => { hud.textContent = 'status: ' + t; hud.className = cls; console.log('[AR]', t); };

    async function warmUpPermission() {
      // Trigger the permission prompt under a user gesture; release immediately.
      const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      s.getTracks().forEach(t => t.stop());
    }

    function injectScene() {
      app.innerHTML = `
        <a-scene
          id="scene"
          embedded
          vr-mode-ui="enabled: false"
          renderer="alpha: false; antialias: true; logarithmicDepthBuffer: true"
          arjs="
            sourceType: webcam;
            videoTexture: true;            /* render camera inside WebGL */
            detectionMode: mono;
            trackingMethod: best;
            debugUIEnabled: false;
            sourceWidth: 640; sourceHeight: 480;
            displayWidth: 1280; displayHeight: 720;
          "
        >
          <!-- Ambient light (emissive materials used below, but keep this) -->
          <a-entity light="type: ambient; intensity: 1.0"></a-entity>

          <!-- Marker-driven camera (camera pose matches marker directly) -->
          <a-marker-camera preset="hiro" emitevents="true"></a-marker-camera>

          <!-- Content at the marker origin (world coords), big & emissive -->
          <a-entity position="0 0.5 0"
                    geometry="primitive: box; depth: 0.35; height: 0.35; width: 0.35"
                    material="color: #39f; emissive: #39f; emissiveIntensity: 0.9; metalness: 0; roughness: 1">
          </a-entity>

          <a-entity position="0 0.9 0"
                    text="value: HIRO FOUND; align: center; width: 3; color: #00ff88"
                    material="side: double">
          </a-entity>
        </a-scene>
      `;

      const scene = document.getElementById('scene');
      scene.addEventListener('arReady', () => log('arReady (AR.js initialized)'));
      scene.addEventListener('arError', e => log('arError: ' + (e && e.detail ? e.detail : 'unknown'), 'error'));

      // We’re using marker-camera; hook its events on the underlying <a-marker> it creates
      // (Some builds still propagate on <a-marker-camera> itself—listen to both.)
      scene.addEventListener('markerFound', () => log('markerFound'));
      scene.addEventListener('markerLost',  () => log('markerLost'));
    }

    async function start() {
      try {
        log('requesting camera…');
        await warmUpPermission();
      } catch (e) {
        const name = e && e.name ? e.name : '';
        let hint = '';
        if (name === 'NotAllowedError' || name === 'SecurityError') hint = '\nEnable camera: Chrome → lock icon → Site settings → Camera → Allow.';
        if (name === 'NotReadableError') hint = '\nCamera busy. Close other camera apps/tabs, force-close Chrome, or reboot.';
        log(`camera error: ${name || e}${hint}`, 'error');
        return;
      }
      overlay.style.display = 'none';
      log('launching AR…');
      injectScene();
    }

    const startBtn = document.getElementById('startBtn');
    const go = (ev) => { ev.preventDefault(); ev.stopPropagation(); start(); };
    startBtn.addEventListener('click', go, { passive:false });
    startBtn.addEventListener('touchend', go, { passive:false });

    // Surface unexpected errors on screen
    window.addEventListener('error', e => log('runtime error: ' + e.message, 'error'));
    window.addEventListener('unhandledrejection', e => {
      const name = (e && e.reason && e.reason.name) ? e.reason.name : '';
      log(`promise rejection${name ? ' ('+name+')' : ''} – see console`, 'error');
      console.error(e.reason || e);
    });
  </script>
</body>
</html>
