<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>AR.js • HIRO (Detects + Visible)</title>

  <!-- Stable combo that worked for you -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }

    /* Ensure AR.js video is visible behind WebGL */
    #arjs-video{
      position:fixed !important; inset:0 !important;
      width:100% !important; height:100% !important;
      object-fit:cover !important;
      z-index:0 !important; display:block !important; visibility:visible !important; opacity:1 !important;
      background:#000;
    }

    /* WebGL canvas sits above video and stays transparent */
    canvas.a-canvas{
      position:fixed !important; inset:0 !important;
      width:100% !important; height:100% !important;
      z-index:1 !important; background:transparent !important; pointer-events:none;
    }

    /* HUD */
    #hud{
      position:fixed; top:8px; left:8px; z-index:2;
      background:rgba(0,0,0,.65); color:#0f0; font:12px/1.4 monospace;
      padding:6px 8px; border-radius:6px; white-space:pre-wrap; max-width:90vw; display:none
    }
    #hud.show{display:block} #hud.error{display:block; background:rgba(160,0,0,.85); color:#fff}

    /* Start overlay */
    #overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:#000; color:#fff; z-index:3; text-align:center; padding:24px; font:16px/1.5 system-ui,sans-serif
    }
    #overlay button{margin-top:12px; padding:12px 16px; border:0; border-radius:10px; font-weight:700; background:#1e90ff; color:#fff}
  </style>
</head>
<body>
  <div id="overlay">
    <div>
      <div>This needs your camera to show AR on the <b>HIRO</b> marker.</div>
      <button id="startBtn" type="button">Start AR</button>
      <div style="margin-top:10px;font-size:12px;opacity:.8">If you blocked the camera: Chrome → lock icon → Site settings → Camera → Allow.</div>
    </div>
  </div>

  <div id="hud">status: booting…</div>
  <div id="app"></div>

  <script>
    const hud = document.getElementById('hud');
    const overlay = document.getElementById('overlay');
    const app = document.getElementById('app');
    const log = (t, cls='show') => { hud.textContent = 'status: ' + t; hud.className = cls; console.log('[AR]', t); };

    async function warmUpPermission(){
      const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      s.getTracks().forEach(t => t.stop());
    }

    function ensureArVideoVisible(){
      const tick = () => {
        const v = document.getElementById('arjs-video');
        if (!v) return requestAnimationFrame(tick);
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted = true; v.autoplay = true;
        v.style.position='fixed'; v.style.inset='0'; v.style.width='100%'; v.style.height='100%';
        v.style.objectFit='cover'; v.style.zIndex='0'; v.style.display='block'; v.style.visibility='visible'; v.style.opacity='1';
        v.play().catch(()=>{});
        v.addEventListener('loadedmetadata', ()=> log(`AR.js video ready: ${v.videoWidth}×${v.videoHeight}`));
      };
      tick();
    }

    function injectScene(){
      app.innerHTML = `
        <a-scene
          id="scene"
          embedded
          vr-mode-ui="enabled: false"
          renderer="alpha: true; antialias: true; logarithmicDepthBuffer: true"
          arjs="sourceType: webcam; detectionMode: mono; trackingMethod: best; debugUIEnabled: true; sourceWidth: 640; sourceHeight: 480; displayWidth: 1280; displayHeight: 720;"
        >
          <!-- Small ambient, but we use emissive so lights don't matter -->
          <a-entity light="type: ambient; intensity: 0.6"></a-entity>

          <!-- Use the standard marker entity (this was detecting for you) -->
          <a-marker preset="hiro" emitevents="true">
            <!-- BIG, flat, double-sided, emissive geometry so it's guaranteed visible -->
            <a-box position="0 0.6 0" width="0.9" height="0.9" depth="0.9"
                   material="shader: flat; color: #39f; side: double; emissive: #39f; emissiveIntensity: 1.0; metalness: 0; roughness: 1"></a-box>
            <a-entity position="0 1.2 0"
                      text="value: HIRO FOUND; align: center; width: 3.2; color: #00ff88"
                      material="shader: flat; side: double"></a-entity>
          </a-marker>

          <!-- Normal camera -->
          <a-entity camera="fov: 80; near: 0.01; far: 1000"></a-entity>
        </a-scene>
      `;

      ensureArVideoVisible();

      const scene = document.getElementById('scene');
      scene.addEventListener('arReady', () => log('arReady (AR.js initialized)'));
      scene.addEventListener('arError', e => log('arError: ' + (e && e.detail ? e.detail : 'unknown'), 'error'));

      const marker = document.querySelector('a-marker');
      if (marker){
        marker.addEventListener('markerFound', () => log('markerFound'));
        marker.addEventListener('markerLost',  () => log('markerLost'));
      }
    }

    async function start(){
      try{
        log('requesting camera…');
        await warmUpPermission();
      }catch(e){
        const name=e&&e.name?e.name:''; let hint='';
        if(name==='NotAllowedError'||name==='SecurityError') hint='\nEnable camera: Chrome → lock icon → Site settings → Camera → Allow.';
        if(name==='NotReadableError') hint='\nCamera busy. Close other camera apps/tabs, force-close Chrome, or reboot.';
        log(`camera error: ${name || e}${hint}`,'error'); return;
      }
      overlay.style.display='none';
      log('launching AR…');
      injectScene();
    }

    const go = (ev)=>{ev.preventDefault(); ev.stopPropagation(); start();};
    document.getElementById('startBtn').addEventListener('click', go, {passive:false});
    document.getElementById('startBtn').addEventListener('touchend', go, {passive:false});

    window.addEventListener('error', e => log('runtime error: ' + e.message, 'error'));
    window.addEventListener('unhandledrejection', e => {
      const name=(e && e.reason && e.reason.name)?e.reason.name:'';
      log(`promise rejection${name ? ' ('+name+')' : ''} – see console`, 'error');
      console.error(e.reason || e);
    });
  </script>
</body>
</html>
