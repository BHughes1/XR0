<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>AR.js • Hiro Minimal (Reliable Start)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- AR.js for A-Frame (stable npm build) -->
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    /* Keep AR.js video from stretching; switch to 'cover' if you prefer edge-to-edge */
    video#arjs-video { object-fit: contain !important; width:100% !important; height:100% !important; }
    canvas.a-canvas { width:100% !important; height:100% !important; background:transparent !important; }

    /* Start overlay – very high z-index to guarantee it's on top and clickable */
    #overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:#000; color:#fff; z-index:99999; text-align:center; padding:24px;
      font:16px/1.5 system-ui, sans-serif;
    }
    #overlay.hidden { display:none; }
    #overlay button {
      margin-top:12px; padding:12px 16px; border:0; border-radius:10px; font-weight:700;
      background:#1e90ff; color:#fff;
    }

    /* HUD for quick diagnostics */
    #hud {
      position:fixed; top:8px; left:8px; z-index:100000;
      background:rgba(0,0,0,.65); color:#0f0; font:12px/1.4 monospace;
      padding:6px 8px; border-radius:6px; max-width:80vw; white-space:pre-wrap; display:none;
    }
    #hud.error { color:#fff; background:rgba(160,0,0,.85); display:block; }
  </style>
</head>
<body>
  <!-- Start / Permission overlay -->
  <div id="overlay">
    <div>
      <div>This demo needs your camera to show AR on the <b>HIRO</b> marker.</div>
      <button id="startBtn" type="button">Start AR</button>
      <div style="margin-top:10px; font-size:12px; opacity:.8">
        If you blocked camera before: Chrome → lock icon → Site settings → Camera → Allow, then tap Start again.
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div id="hud">status: booting…</div>

  <!-- We inject the scene into this container AFTER permission succeeds -->
  <div id="app"></div>

  <script>
    const hud = document.getElementById('hud');
    const overlay = document.getElementById('overlay');
    const app = document.getElementById('app');
    const startBtn = document.getElementById('startBtn');

    function setHUD(t, isError=false){
      hud.textContent = 'status: ' + t;
      hud.className = isError ? 'error' : '';
      hud.style.display = 'block';
      console.log('[AR]', t);
    }

    // Ensure the button really receives a user gesture on all devices
    const startHandler = async (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      setHUD('requesting camera…');

      // Step 1: explicitly request camera on the user gesture
      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });
      } catch (e) {
        const name = e && e.name ? e.name : '';
        let hint = '';
        if (name === 'NotAllowedError' || name === 'SecurityError')
          hint = '\nCamera permission blocked. Chrome → lock icon → Site settings → Camera → Allow.';
        else if (name === 'NotReadableError')
          hint = '\nCamera busy. Close other camera apps/tabs, force-close Chrome, or reboot.';
        setHUD(`camera error: ${name || e}${hint}`, true);
        return;
      }

      // Step 2: patch getUserMedia so AR.js uses the granted stream
      const origGUM = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
      navigator.mediaDevices.getUserMedia = () => Promise.resolve(stream);

      // Step 3: hide overlay and inject a tiny Hiro scene
      overlay.classList.add('hidden');
      app.innerHTML = `
        <a-scene
          embedded
          vr-mode-ui="enabled: false"
          renderer="alpha: true; antialias: true; logarithmicDepthBuffer: true"
          arjs="sourceType: webcam; detectionMode: mono; trackingMethod: best; debugUIEnabled: false;"
          id="scene"
        >
          <a-entity light="type: ambient; intensity: 1.0"></a-entity>
          <a-entity light="type: directional; intensity: 0.9" position="0 1 1"></a-entity>

          <a-marker preset="hiro" emitevents="true">
            <a-plane position="0 0 0" rotation="-90 0 0" width="1.2" height="1.2" color="#ffffff"></a-plane>
            <a-box position="0 0.2 0" depth="0.12" height="0.12" width="0.12" color="#39f"></a-box>
            <a-entity position="0 0.45 0" text="value: HIRO; align: center; width: 2.5; color: #00ff88"></a-entity>
          </a-marker>

          <a-entity camera="fov: 80"></a-entity>
        </a-scene>
      `;

      // Step 4: ensure AR.js internal video really plays
      const attachArVideo = () => {
        const v = document.getElementById('arjs-video');
        if (!v) return requestAnimationFrame(attachArVideo);
        if (!v.srcObject) v.srcObject = stream;
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted = true; v.autoplay = true;
        v.addEventListener('loadedmetadata', () => {
          setHUD(`AR.js video ready: ${v.videoWidth}×${v.videoHeight}`);
          if (!v.videoWidth || !v.videoHeight) setHUD('Warning: AR.js video size is 0×0 — reload or restart Chrome', true);
        });
        v.play().catch(()=>{});
      };
      attachArVideo();

      // Optional diagnostics
      const scene = document.getElementById('scene');
      scene.addEventListener('arReady', () => setHUD('arReady (AR.js initialized)'));
      scene.addEventListener('arError', e => setHUD('arError: ' + (e && e.detail ? e.detail : 'unknown'), true));

      const marker = document.querySelector('a-marker');
      if (marker){
        marker.addEventListener('markerFound', () => setHUD('markerFound'));
        marker.addEventListener('markerLost',  () => setHUD('markerLost'));
      }
    };

    // Attach both click and touchend to be safe
    startBtn.addEventListener('click', startHandler, { passive: false });
    startBtn.addEventListener('touchend', startHandler, { passive: false });

    // Show a clear error if anything else breaks
    window.addEventListener('error', e => setHUD('runtime error: ' + e.message + ' (see console)', true));
    window.addEventListener('unhandledrejection', e => {
      const name = e && e.reason && e.reason.name ? e.reason.name : '';
      setHUD(`promise rejection${name ? ' ('+name+')' : ''} – see console`, true);
      console.error(e.reason || e);
    });
  </script>
</body>
</html>
