<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>AR.js • Hiro with Permission Prompt</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    /* Keep video from stretching; switch to cover for edge-to-edge */
    video#arjs-video { object-fit: contain !important; width:100% !important; height:100% !important; }
    canvas.a-canvas { width:100% !important; height:100% !important; }

    /* Overlay UI */
    #overlay {
      position:fixed; inset:0; z-index:20; display:flex; align-items:center; justify-content:center;
      background:#000; color:#fff; padding:24px; text-align:center; font:16px/1.5 system-ui, sans-serif;
    }
    #overlay.hidden { display:none; }
    #overlay button {
      margin-top:12px; padding:12px 16px; border:0; border-radius:10px; font-weight:700;
      background:#1e90ff; color:#fff;
    }
    #msg { white-space:pre-wrap; opacity:.9; }
    #hud {
      position:fixed; top:8px; left:8px; z-index:10;
      background:rgba(0,0,0,.65); color:#0f0; font:12px/1.4 monospace;
      padding:6px 8px; border-radius:6px; max-width:80vw; white-space:pre-wrap; display:none;
    }
    #hud.error { color:#fff; background:rgba(160,0,0,.85); display:block; }
  </style>
</head>
<body>
  <!-- Startup/permission overlay -->
  <div id="overlay">
    <div>
      <div id="msg">This demo needs your camera to show AR content on the HIRO marker.</div>
      <button id="startBtn">Allow Camera & Start AR</button>
      <div style="margin-top:10px; font-size:12px; opacity:.8">
        Tip: If you previously blocked the camera, tap the lock icon in Chrome → Site settings → Camera → Allow, then return here and tap the button again.
      </div>
    </div>
  </div>

  <!-- Status HUD -->
  <div id="hud">status: booting…</div>

  <!-- Scene is injected after permission succeeds -->
  <a-scene id="scene" style="display:none"
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true"
    arjs="sourceType: webcam; detectionMode: mono; trackingMethod: best; debugUIEnabled: false;"
  >
    <!-- Default HIRO marker -->
    <a-marker preset="hiro" emitevents="true">
      <a-plane position="0 0 0" rotation="-90 0 0" width="1" height="1" color="#ffffff"></a-plane>
      <a-box position="0 0.15 0" depth="0.1" height="0.1" width="0.1" color="#39f"></a-box>
      <a-entity position="0 0.35 0" text="value: HIRO detected; align: center; width: 2"></a-entity>
    </a-marker>
    <a-entity camera="fov: 80"></a-entity>
  </a-scene>

  <script>
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const sceneEl = document.getElementById('scene');
    const hud = document.getElementById('hud');
    const msg = document.getElementById('msg');

    function setHUD(t, isError=false){ hud.textContent = 'status: ' + t; hud.className = isError ? 'error' : ''; hud.style.display='block'; console.log('[AR]', t); }

    // Try to read current permission state (not supported everywhere)
    async function getCameraPermissionState(){
      if (!('permissions' in navigator)) return 'unknown';
      try {
        const s = await navigator.permissions.query({ name: 'camera' });
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'unknown'; }
    }

    async function requestCameraOnce(){
      // Trigger real prompt via getUserMedia (user gesture required)
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });
        // We only needed permission; stop tracks and let AR.js take over
        stream.getTracks().forEach(t => t.stop());
        return { ok: true };
      } catch (e) {
        return { ok: false, error: e };
      }
    }

    function bootAR(){
      overlay.classList.add('hidden');
      sceneEl.style.display = '';
      setHUD('starting AR (watch for camera feed)…');
      // Ensure inline playback once AR.js video appears
      (function waitVideo(){
        const v = document.getElementById('arjs-video');
        if (!v) return requestAnimationFrame(waitVideo);
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted = true;
        v.addEventListener('loadedmetadata', () => setHUD(`camera streaming ${v.videoWidth}x${v.videoHeight}`));
      })();
      // Marker debug
      const marker = document.querySelector('a-marker');
      if (marker){
        marker.addEventListener('markerFound', () => setHUD('marker FOUND'));
        marker.addEventListener('markerLost',  () => setHUD('marker lost…'));
      }
    }

    startBtn.addEventListener('click', async () => {
      setHUD('requesting camera permission…');
      const res = await requestCameraOnce();
      if (res.ok){
        setHUD('permission granted; launching AR…');
        bootAR();
      } else {
        const name = (res.error && res.error.name) ? res.error.name : '';
        let hint = '';
        if (name === 'NotAllowedError' || name === 'SecurityError'){
          hint = '\nCamera permission is blocked.\nChrome → lock icon → Site settings → Camera → Allow\nThen return and tap the button again.';
        } else if (name === 'NotReadableError'){
          hint = '\nCamera is busy (used by another app or tab).\nClose other apps using the camera (QR scanners, video calls), force-close Chrome, or reboot.';
        } else if (name === 'NotFoundError' || name === 'OverconstrainedError'){
          hint = '\nNo suitable camera found. Remove constraints or try another browser/device.';
        }
        setHUD(`camera error: ${name || res.error}\n${hint}`, true);
        msg.textContent = `We couldn't access the camera (${name || res.error}).\n${hint}\n\nAfter fixing, tap the button to try again.`;
      }
    });

    // If already granted, skip the overlay and start immediately
    (async () => {
      const state = await getCameraPermissionState();
      if (state === 'granted'){
        setHUD('camera already allowed; launching AR…');
        bootAR();
      } else if (state === 'denied'){
        msg.textContent = 'Camera permission is currently blocked.\nChrome → lock icon → Site settings → Camera → Allow\nThen tap the button below.';
      } else {
        // 'prompt' or 'unknown' → wait for user tap
        msg.textContent = 'This demo needs your camera to show AR content on the HIRO marker.\nTap the button to allow and start.';
      }
    })();

    // Surface unexpected runtime errors
    window.addEventListener('error', e => setHUD('runtime error: ' + e.message + ' (see console)', true));
    window.addEventListener('unhandledrejection', e => {
      const name = (e && e.reason && e.reason.name) ? e.reason.name : '';
      setHUD(`promise rejection${name ? ' ('+name+')' : ''} – see console`, true);
      console.error(e.reason || e);
    });
  </script>
</body>
</html>
